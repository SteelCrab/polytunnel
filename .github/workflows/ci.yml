# Continuous Integration workflow for Polytunnel
#
# This workflow runs on every push and pull request to ensure code quality across
# multiple platforms (macOS, Windows, Linux) and architectures (x86_64, aarch64, linux-musl).
# It performs:
# 1. Build verification on all supported platforms
# 2. Unit tests
# 3. Code linting (clippy)
# 4. Code formatting checks
# 5. Code coverage analysis (llvm-cov)

name: CI

# Trigger conditions
on:
  push:
    # Run on all branches except docs
    branches:
      - '**'
      - '!docs'
  pull_request:
    # Run on all pull requests except docs
    branches:
      - '**'
      - '!docs'

env:
  # Use stable Rust toolchain
  RUST_TOOLCHAIN: stable
  # Set Cargo output format to JSON for better parsing
  CARGO_TERM_COLOR: always

jobs:
  # Job 1: Build on Linux x86_64
  build-linux-x86:
    name: Build (Linux x86_64)
    runs-on: ubuntu-latest
    steps:
      # Checkout repository code
      - name: Checkout repository
        uses: actions/checkout@v4

      # Install Rust toolchain
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      # Cache dependencies to speed up builds
      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: ${{ runner.os }}-cargo-${{ env.RUST_TOOLCHAIN }}-linux-x86_64

      # Build workspace in debug mode
      - name: Build workspace
        run: cargo build --workspace --verbose

  # Job 2: Build on macOS x86_64 (cross-compile from arm64 runner)
  build-macos-x86:
    name: Build (macOS x86_64)
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Add x86_64 target
        run: rustup target add x86_64-apple-darwin

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: ${{ runner.os }}-cargo-${{ env.RUST_TOOLCHAIN }}-macos-x86_64

      - name: Build workspace (x86_64)
        run: cargo build --workspace --target x86_64-apple-darwin --verbose

  # Job 3: Build on macOS aarch64 (Apple Silicon, native)
  build-macos-aarch64:
    name: Build (macOS aarch64)
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: ${{ runner.os }}-cargo-${{ env.RUST_TOOLCHAIN }}-macos-aarch64

      # Build for Apple Silicon (native)
      - name: Build workspace (aarch64)
        run: cargo build --workspace --verbose

  # Job 4: Build on Windows x86_64
  build-windows-x86:
    name: Build (Windows x86_64)
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: ${{ runner.os }}-cargo-${{ env.RUST_TOOLCHAIN }}-windows-x86_64

      - name: Build workspace
        run: cargo build --workspace --verbose

  # Job 5: Build for Linux aarch64 (cross-compilation)
  build-linux-aarch64:
    name: Build (Linux aarch64)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      # Add aarch64 target for cross-compilation
      - name: Add aarch64 target
        run: rustup target add aarch64-unknown-linux-gnu

      # Install cross-compilation tools
      - name: Install aarch64 cross-compilation tools
        run: sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: ${{ runner.os }}-cargo-${{ env.RUST_TOOLCHAIN }}-linux-aarch64-cross

      - name: Build workspace (aarch64)
        run: cargo build --workspace --target aarch64-unknown-linux-gnu --verbose
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
          CC_aarch64_unknown_linux_gnu: aarch64-linux-gnu-gcc
          CXX_aarch64_unknown_linux_gnu: aarch64-linux-gnu-g++

  # Job 6: Build for Linux musl x86_64 (static binary)
  build-linux-musl:
    name: Build (Linux musl)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install musl-tools
        run: sudo apt-get update && sudo apt-get install -y musl-tools

      - name: Add musl target
        run: rustup target add x86_64-unknown-linux-musl

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: ${{ runner.os }}-cargo-${{ env.RUST_TOOLCHAIN }}-linux-musl

      - name: Build workspace (musl)
        run: cargo build --workspace --target x86_64-unknown-linux-musl --verbose

  # Job 7: Run all unit tests (Linux only)
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: ${{ runner.os }}-cargo-${{ env.RUST_TOOLCHAIN }}-linux-test

      # Run tests with output (don't stop on first failure)
      - name: Run tests
        run: cargo test --workspace --verbose

      # Run documentation tests
      - name: Run doc tests
        run: cargo test --doc --workspace --verbose

  # Job 8: Code linting with Clippy
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: ${{ runner.os }}-cargo-${{ env.RUST_TOOLCHAIN }}-linux-lint

      # Run Clippy with strict warnings (-D warnings)
      # This will fail the build if there are any warnings
      - name: Run Clippy
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

  # Job 9: Code formatting check
  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      # Check code formatting without modifying files
      - name: Check code formatting
        run: cargo fmt --check

  # Job 10: Build release binary on Linux x86_64
  release-linux:
    name: Release Build (Linux x86_64)
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/') || startsWith(github.ref, 'refs/tags/v'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: ${{ runner.os }}-cargo-${{ env.RUST_TOOLCHAIN }}-linux-release

      # Build in release mode for optimization
      - name: Build release binary
        run: cargo build --workspace --release --verbose

      - name: Package artifact
        run: |
          VERSION=$(cargo metadata --no-deps --format-version 1 | python3 -c "import sys,json; d=json.load(sys.stdin); print(next(p['version'] for p in d['packages'] if p['name']=='polytunnel'))")
          TARGET=linux-x86_64
          mkdir -p dist
          cp target/release/polytunnel README.md README_KR.md LICENSE dist/
          cp -r examples dist/
          tar -czf polytunnel-${VERSION}-${TARGET}.tar.gz -C dist .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: polytunnel-linux-x86_64
          path: polytunnel-*.tar.gz

  # Job 11: Build release binary on Linux aarch64
  release-linux-aarch64:
    name: Release Build (Linux aarch64)
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/') || startsWith(github.ref, 'refs/tags/v'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Add aarch64 target
        run: rustup target add aarch64-unknown-linux-gnu

      - name: Install aarch64 cross-compilation tools
        run: sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: linux-aarch64-release

      - name: Build release binary (aarch64)
        run: cargo build --workspace --release --target aarch64-unknown-linux-gnu --verbose
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc
          CC_aarch64_unknown_linux_gnu: aarch64-linux-gnu-gcc
          CXX_aarch64_unknown_linux_gnu: aarch64-linux-gnu-g++

      - name: Package artifact
        run: |
          VERSION=$(cargo metadata --no-deps --format-version 1 | python3 -c "import sys,json; d=json.load(sys.stdin); print(next(p['version'] for p in d['packages'] if p['name']=='polytunnel'))")
          TARGET=linux-aarch64
          mkdir -p dist
          cp target/aarch64-unknown-linux-gnu/release/polytunnel README.md README_KR.md LICENSE dist/
          cp -r examples dist/
          tar -czf polytunnel-${VERSION}-${TARGET}.tar.gz -C dist .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: polytunnel-linux-aarch64
          path: polytunnel-*.tar.gz

  # Job 12: Build release binary on Linux musl x86_64 (static binary)
  release-linux-musl:
    name: Release Build (Linux musl)
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/') || startsWith(github.ref, 'refs/tags/v'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install musl-tools
        run: sudo apt-get update && sudo apt-get install -y musl-tools

      - name: Add musl target
        run: rustup target add x86_64-unknown-linux-musl

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: linux-musl-release

      - name: Build release binary (musl)
        run: cargo build --workspace --release --target x86_64-unknown-linux-musl --verbose

      - name: Package artifact
        run: |
          VERSION=$(cargo metadata --no-deps --format-version 1 | python3 -c "import sys,json; d=json.load(sys.stdin); print(next(p['version'] for p in d['packages'] if p['name']=='polytunnel'))")
          TARGET=linux-musl
          mkdir -p dist
          cp target/x86_64-unknown-linux-musl/release/polytunnel README.md README_KR.md LICENSE dist/
          cp -r examples dist/
          tar -czf polytunnel-${VERSION}-${TARGET}.tar.gz -C dist .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: polytunnel-linux-musl
          path: polytunnel-*.tar.gz

  # Job 13: Build release binary on Linux aarch64 musl (static binary on ARM)
  release-linux-aarch64-musl:
    name: Release Build (Linux aarch64 musl)
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/') || startsWith(github.ref, 'refs/tags/v'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cross-compilation tools
        run: sudo apt-get update && sudo apt-get install -y gcc-aarch64-linux-gnu musl-tools

      - name: Add aarch64 musl target
        run: rustup target add aarch64-unknown-linux-musl

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: linux-aarch64-musl-release

      - name: Build release binary (aarch64 musl)
        run: cargo build --workspace --release --target aarch64-unknown-linux-musl --verbose
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_MUSL_LINKER: aarch64-linux-gnu-gcc
          CC_aarch64_unknown_linux_musl: aarch64-linux-gnu-gcc

      - name: Package artifact
        run: |
          VERSION=$(cargo metadata --no-deps --format-version 1 | python3 -c "import sys,json; d=json.load(sys.stdin); print(next(p['version'] for p in d['packages'] if p['name']=='polytunnel'))")
          TARGET=linux-aarch64-musl
          mkdir -p dist
          cp target/aarch64-unknown-linux-musl/release/polytunnel README.md README_KR.md LICENSE dist/
          cp -r examples dist/
          tar -czf polytunnel-${VERSION}-${TARGET}.tar.gz -C dist .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: polytunnel-linux-aarch64-musl
          path: polytunnel-*.tar.gz

  # Job 14: Build release binary on macOS aarch64 (Apple Silicon)
  release-macos-aarch64:
    name: Release Build (macOS aarch64)
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/') || startsWith(github.ref, 'refs/tags/v'))
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      # Add aarch64 target for Apple Silicon
      - name: Add aarch64 target
        run: rustup target add aarch64-apple-darwin

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: ${{ runner.os }}-cargo-${{ env.RUST_TOOLCHAIN }}-macos-aarch64-release

      # Build release for Apple Silicon
      - name: Build release binary (aarch64)
        run: cargo build --workspace --release --target aarch64-apple-darwin --verbose

      - name: Package artifact
        run: |
          VERSION=$(cargo metadata --no-deps --format-version 1 | python3 -c "import sys,json; d=json.load(sys.stdin); print(next(p['version'] for p in d['packages'] if p['name']=='polytunnel'))")
          TARGET=macos-aarch64
          mkdir -p dist
          cp target/aarch64-apple-darwin/release/polytunnel README.md README_KR.md LICENSE dist/
          cp -r examples dist/
          tar -czf polytunnel-${VERSION}-${TARGET}.tar.gz -C dist .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: polytunnel-macos-aarch64
          path: polytunnel-*.tar.gz

  # Job 15: Build release binary on Windows x86_64
  release-windows:
    name: Release Build (Windows x86_64)
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/') || startsWith(github.ref, 'refs/tags/v'))
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: ${{ runner.os }}-cargo-${{ env.RUST_TOOLCHAIN }}-windows-release

      - name: Build release binary
        run: cargo build --workspace --release --verbose

      - name: Package artifact
        shell: pwsh
        run: |
          $version = (cargo metadata --no-deps --format-version 1 | ConvertFrom-Json).packages | Where-Object { $_.name -eq 'polytunnel' } | Select-Object -ExpandProperty version
          New-Item -ItemType Directory -Force dist
          Copy-Item target\release\polytunnel.exe, README.md, README_KR.md, LICENSE dist\
          Copy-Item examples dist\ -Recurse
          Compress-Archive -Path dist\* -DestinationPath "polytunnel-$version-windows-x86_64.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: polytunnel-windows-x86_64
          path: polytunnel-*.zip

  # Job 16: Build release binary on Windows ARM64
  release-windows-arm64:
    name: Release Build (Windows ARM64)
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/') || startsWith(github.ref, 'refs/tags/v'))
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Add ARM64 target
        run: rustup target add aarch64-pc-windows-msvc

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: windows-arm64-release

      - name: Build release binary (ARM64)
        run: cargo build --workspace --release --target aarch64-pc-windows-msvc --verbose

      - name: Package artifact
        shell: pwsh
        run: |
          $version = (cargo metadata --no-deps --format-version 1 | ConvertFrom-Json).packages | Where-Object { $_.name -eq 'polytunnel' } | Select-Object -ExpandProperty version
          New-Item -ItemType Directory -Force dist
          Copy-Item target\aarch64-pc-windows-msvc\release\polytunnel.exe, README.md, README_KR.md, LICENSE dist\
          Copy-Item examples dist\ -Recurse
          Compress-Archive -Path dist\* -DestinationPath "polytunnel-$version-windows-arm64.zip"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: polytunnel-windows-arm64
          path: polytunnel-*.zip

  # Job 17: Code coverage with llvm-cov
  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: ${{ runner.os }}-cargo-${{ env.RUST_TOOLCHAIN }}-linux-coverage

      # Install llvm-cov
      - name: Install llvm-cov
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-llvm-cov@0.8.4

      # Generate code coverage report
      - name: Generate code coverage
        run: cargo llvm-cov --workspace --fail-under-lines 85 --lcov --output-path lcov.info

      # Upload coverage to codecov
      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./lcov.info
          fail_ci_if_error: false

  # Job 18: Security audit
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Run security audit
        run: cargo audit

  # Job 19: Generate SHA256SUMS from all release artifacts
  checksum:
    name: Generate SHA256SUMS
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/release/') || startsWith(github.ref, 'refs/tags/v'))
    needs:
      - release-linux
      - release-linux-aarch64
      - release-linux-musl
      - release-linux-aarch64-musl
      - release-macos-aarch64
      - release-windows
      - release-windows-arm64
    runs-on: ubuntu-latest
    steps:
      - name: Download all release artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Generate SHA256SUMS
        run: |
          cd artifacts
          sha256sum polytunnel-* > SHA256SUMS
          cat SHA256SUMS

      - name: Upload SHA256SUMS
        uses: actions/upload-artifact@v4
        with:
          name: SHA256SUMS
          path: artifacts/SHA256SUMS
